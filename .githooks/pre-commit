#!/bin/bash

# ğŸ›¡ï¸ PRE-COMMIT HOOK: Multitenancy Pattern Validation
# Este hook se ejecuta automÃ¡ticamente antes de cada commit

echo "ğŸ” Running pre-commit multitenancy validation..."

# Verificar si hay cambios en repositories, DTOs o APIs
CHANGED_FILES=$(git diff --cached --name-only | grep -E "(Repository|Dto|Api)\.kt$")

if [ -n "$CHANGED_FILES" ]; then
    echo "ğŸ“‹ Detected changes in multitenancy-related files:"
    echo "$CHANGED_FILES" | while read file; do
        echo "  - $file"
    done
    
    echo ""
    echo "ğŸ—ï¸ Validating multitenancy pattern..."
    
    # Ejecutar el script de validaciÃ³n
    if [ -f "scripts/validate_multitenancy_pattern.sh" ]; then
        bash scripts/validate_multitenancy_pattern.sh
        
        # Si la validaciÃ³n falla, bloquear el commit
        if [ $? -ne 0 ]; then
            echo ""
            echo "ğŸš« COMMIT BLOCKED: Multitenancy pattern validation failed!"
            echo "Please fix the errors above before committing."
            echo ""
            echo "ğŸ’¡ Quick fixes:"
            echo "  1. Ensure repositories with businessId inject BusinessContextManager"
            echo "  2. Add debugging logs to repository save methods"
            echo "  3. Include businessId in API query parameters"
            echo "  4. Check MULTITENANCY_PATTERN.md for guidance"
            exit 1
        fi
    else
        echo "âš ï¸  Warning: Validation script not found. Skipping validation."
    fi
else
    echo "âœ… No multitenancy-related files changed. Skipping validation."
fi

echo "âœ… Pre-commit validation passed!"
exit 0 