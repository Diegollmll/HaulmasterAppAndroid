#!/bin/bash

# 🛡️ PRE-COMMIT HOOK: Multitenancy Pattern Validation
# Este hook se ejecuta automáticamente antes de cada commit

echo "🔍 Running pre-commit multitenancy validation..."

# Verificar si hay cambios en repositories, DTOs o APIs
CHANGED_FILES=$(git diff --cached --name-only | grep -E "(Repository|Dto|Api)\.kt$")

if [ -n "$CHANGED_FILES" ]; then
    echo "📋 Detected changes in multitenancy-related files:"
    echo "$CHANGED_FILES" | while read file; do
        echo "  - $file"
    done
    
    echo ""
    echo "🏗️ Validating multitenancy pattern..."
    
    # Ejecutar el script de validación
    if [ -f "scripts/validate_multitenancy_pattern.sh" ]; then
        bash scripts/validate_multitenancy_pattern.sh
        
        # Si la validación falla, bloquear el commit
        if [ $? -ne 0 ]; then
            echo ""
            echo "🚫 COMMIT BLOCKED: Multitenancy pattern validation failed!"
            echo "Please fix the errors above before committing."
            echo ""
            echo "💡 Quick fixes:"
            echo "  1. Ensure repositories with businessId inject BusinessContextManager"
            echo "  2. Add debugging logs to repository save methods"
            echo "  3. Include businessId in API query parameters"
            echo "  4. Check MULTITENANCY_PATTERN.md for guidance"
            exit 1
        fi
    else
        echo "⚠️  Warning: Validation script not found. Skipping validation."
    fi
else
    echo "✅ No multitenancy-related files changed. Skipping validation."
fi

echo "✅ Pre-commit validation passed!"
exit 0 